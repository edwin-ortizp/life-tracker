import{r as l}from"./react-vendor-B6CgFIIW.js";import{u as w,d as p}from"../assets/index-B6EFx1d9.js";import{q as E,w as h,l as m,h as N,k as d,t as I,e as f,u as D,n as S}from"./firebase-B1tATv4n.js";const C=()=>{const{user:n}=w(),[y,u]=l.useState([]),[q,a]=l.useState("idle"),[v,i]=l.useState(null);l.useEffect(()=>{if(!n){u([]);return}a("loading");const t=E(m(p,"shopping-list"),h("userId","==",n.uid)),e=N(t,r=>{if(r.empty){u([]),a("idle");return}const s=r.docs.map(g=>{const o=g.data();return{id:g.id,name:o.name||"",quantity:o.quantity||0,status:o.status||"to-buy",...o.price!==void 0&&{price:o.price},...o.category&&{category:o.category},...o.place&&{place:o.place}}});u(s),a("idle")},r=>{(r==null?void 0:r.code)==="permission-denied"?(i("Error de permisos - Verificar reglas de Firestore"),a("error")):(i(r instanceof Error?r.message:"Error al cargar"),a("error"),u([]))});return()=>{e()}},[n]);const b=async t=>{if(!n){i("Usuario no autenticado");return}a("saving"),i(null);try{const e=y.find(s=>s.name.toLowerCase()===t.name.toLowerCase());if(e){const s=e.quantity+Number(t.quantity);e.status==="low-stock"?await c(e.id,{quantity:s}):e.status==="to-buy"?await c(e.id,{quantity:s,status:"in-stock"}):await c(e.id,{quantity:s}),a("idle");return}const r={userId:n.uid,name:t.name,quantity:Number(t.quantity),status:t.status,createdAt:d(),updatedAt:d()};t.price!==void 0&&t.price!==null&&!isNaN(Number(t.price))&&(r.price=Number(t.price)),t.category&&typeof t.category=="string"&&t.category.trim()!==""&&(r.category=t.category.trim()),t.place&&typeof t.place=="string"&&t.place.trim()!==""&&(r.place=t.place.trim()),await I(m(p,"shopping-list"),r),a("idle")}catch(e){const r=e instanceof Error?e.message:"Error al guardar";i(r),a("error")}},c=async(t,e)=>{if(!n){i("Usuario no autenticado");return}a("saving"),i(null);try{const r=f(p,"shopping-list",t),s={updatedAt:d()};e.name!==void 0&&(s.name=e.name),e.quantity!==void 0&&(s.quantity=Number(e.quantity)),e.status!==void 0&&(s.status=e.status),e.price!==void 0&&e.price!==null&&!isNaN(Number(e.price))&&(s.price=Number(e.price)),e.category!==void 0&&typeof e.category=="string"&&e.category.trim()!==""&&(s.category=e.category.trim()),e.place!==void 0&&typeof e.place=="string"&&e.place.trim()!==""&&(s.place=e.place.trim()),await D(r,s),a("idle")}catch(r){const s=r instanceof Error?r.message:"Error al actualizar";i(s),a("error")}};return{items:y,status:q,error:v,addItem:b,updateItem:c,deleteItem:async t=>{if(!n){i("Usuario no autenticado");return}a("saving"),i(null);try{await S(f(p,"shopping-list",t)),a("idle")}catch(e){const r=e instanceof Error?e.message:"Error al eliminar";i(r),a("error")}},moveItem:(t,e)=>{c(t,{status:e})}}};export{C as u};
