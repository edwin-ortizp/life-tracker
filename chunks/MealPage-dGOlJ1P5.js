import{j as e}from"./ui-vendor-DGxrBG5B.js";import{r as b}from"./react-vendor-B6CgFIIW.js";import{C as be,c as we,P as De}from"./PageLayout-CQ502YZp.js";import{B as M,u as fe,d as J,L as ee}from"../assets/index-CZllZBvh.js";import{A as Se,a as Ee}from"./alert-BdSdTxzO.js";import{c as Me,D as Ce,a as Oe,b as $e,d as te}from"./tokens-DP8wmanu.js";import{D as W,a as X,b as K,c as Q,d as ne,f as Te}from"./dialog-Ch6bvtCJ.js";import{M as k,u as ke}from"./useRecipes-2I2ZkUzo.js";import{g as Ae}from"./dates-LQzD1DbF.js";import{g as Pe,C as Ie,t as je,v as Re,j as de,ag as Le,ah as _e,w as Je,V as qe,ai as Ve,a9 as ze,aj as Fe,ak as Ye,h as me,i as Be}from"./chart-vendor-DS0HZnUf.js";import{g as Ge}from"./ai-BhB6E9je.js";import{u as ye}from"./useShoppingList-DeokIW8V.js";import{T as U}from"./textarea-DJSkO8fg.js";import{e as Y,h as He,l as Ue,q as We,w as pe,m as Xe,j as ue,k as se,v as Ke}from"./firebase-B1tATv4n.js";import{A as Qe}from"./TaskAiReprioritize-BKBrXVq4.js";import{S as Ze,a as et,b as tt,c as st,d as at}from"./select-CQQJsJq0.js";import{I as xe}from"./input-DyWC7sCN.js";import"./progress-CKnY0O-_.js";import"./checkbox-Byik9ELG.js";import{A as rt,h as nt,a as ot,b as lt,c as it,d as ct,e as dt,f as mt,g as pt}from"./alert-dialog-Di4Hu8JE.js";import{L as B}from"./label-BZ2qu7W8.js";import{u as ut}from"./usePreparedMeals-BYo7gO5C.js";import"./utils-vendor-zid8MmOQ.js";import"./marked.esm-BiyRy7sW.js";import"./MoodAiSuggestion-COK6RpdY.js";import"./index-DuocBWKh.js";import"./accordion-OgLUcSe4.js";import"./index-4hsSYOGr.js";const oe={breakfast:8,morningSnack:11,lunch:14,afternoonSnack:17,dinner:20},xt=(t,s)=>{const[a,o,i]=t.split("-").map(Number);return new Date(a,o-1,i,oe[s]||0,0,0,0).getTime()<Date.now()},ht=(t=new Date)=>{const s=new Date(t);let a=s.getDay();a=a===0?6:a-1;const o=[];for(let i=0;i<7;i++){const c=new Date(s);c.setDate(s.getDate()-a+i),o.push({dayName:["L","M","X","J","V","S","D"][i],fullDate:Ae(c),isCurrentMonth:c.getMonth()===s.getMonth(),date:new Date(c)})}return o},gt=()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`},ft=1,jt=1e6;let ae=0;function yt(){return ae=(ae+1)%Number.MAX_SAFE_INTEGER,ae.toString()}const re=new Map,he=t=>{if(re.has(t))return;const s=setTimeout(()=>{re.delete(t),F({type:"REMOVE_TOAST",toastId:t})},jt);re.set(t,s)},vt=(t,s)=>{switch(s.type){case"ADD_TOAST":return{...t,toasts:[s.toast,...t.toasts].slice(0,ft)};case"UPDATE_TOAST":return{...t,toasts:t.toasts.map(a=>a.id===s.toast.id?{...a,...s.toast}:a)};case"DISMISS_TOAST":{const{toastId:a}=s;return a?he(a):t.toasts.forEach(o=>{he(o.id)}),{...t,toasts:t.toasts.map(o=>o.id===a||a===void 0?{...o,open:!1}:o)}}case"REMOVE_TOAST":return s.toastId===void 0?{...t,toasts:[]}:{...t,toasts:t.toasts.filter(a=>a.id!==s.toastId)}}},G=[];let H={toasts:[]};function F(t){H=vt(H,t),G.forEach(s=>{s(H)})}function Nt({...t}){const s=yt(),a=i=>F({type:"UPDATE_TOAST",toast:{...i,id:s}}),o=()=>F({type:"DISMISS_TOAST",toastId:s});return F({type:"ADD_TOAST",toast:{...t,id:s,open:!0,onOpenChange:i=>{i||o()}}}),{id:s,dismiss:o,update:a}}function Z(){const[t,s]=b.useState(H);return b.useEffect(()=>(G.push(s),()=>{const a=G.indexOf(s);a>-1&&G.splice(a,1)}),[t]),{...t,toast:Nt,dismiss:a=>F({type:"DISMISS_TOAST",toastId:a})}}const bt=({day:t,mealPlan:s,onOpenModal:a})=>{const o=new Date,i=new Date(t.fullDate),c=i.toDateString()===o.toDateString(),r=i<o&&!c,[x,N]=b.useState(!r),d=Object.keys(s[t.fullDate]||{}).length,f=Object.keys(k).length;return e.jsxs("div",{className:`mx-2 my-3 rounded-xl shadow-sm border transition-all duration-200 ${r?"bg-gray-50 border-gray-200 opacity-75":"bg-white border-gray-100"}`,children:[e.jsxs("div",{className:`flex justify-between items-center p-4 ${r?"cursor-pointer hover:bg-gray-100":""} ${x?"border-b border-gray-100 rounded-t-xl":"rounded-xl"}`,onClick:r?()=>N(!x):void 0,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsx("div",{className:"text-gray-400",children:x?e.jsx(Pe,{className:"w-4 h-4"}):e.jsx(Ie,{className:"w-4 h-4"})}),e.jsxs("h3",{className:`font-semibold text-base ${r?"text-gray-500":c?"text-blue-600":"text-gray-900"}`,children:[t.dayName,c&&" (Hoy)"]}),r&&!x&&e.jsxs("span",{className:"text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-md",children:[d,"/",f]})]}),e.jsx("span",{className:`text-sm px-2 py-1 rounded-md ${r?"text-gray-400 bg-gray-100":"text-gray-500 bg-gray-50"}`,children:t.fullDate.split("-").slice(1).join("/")})]}),x&&e.jsx("div",{className:"p-4 pt-0 space-y-3",children:Object.entries(k).sort(([,n],[,l])=>n.order-l.order).map(([n,l])=>{var p;const y=(p=s[t.fullDate])==null?void 0:p[n],{color:h,hoverColor:j}=l;return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center w-12 shrink-0",children:[e.jsx(l.icon,{className:`w-5 h-5 mb-1 ${r?"text-gray-400":"text-gray-600"}`}),e.jsxs("span",{className:`text-xs text-center leading-tight ${r?"text-gray-400":"text-gray-500"}`,children:[oe[n],":00"]})]}),y?e.jsxs("div",{className:`flex-1 p-3 rounded-lg transition-all duration-200 cursor-pointer border active:scale-95 ${r?"bg-gray-100 border-gray-200 hover:bg-gray-150":`${h} ${j} border-gray-200`}`,onClick:()=>a(t.fullDate,n,y),children:[e.jsx("div",{className:`font-medium text-sm mb-1 line-clamp-1 ${r?"text-gray-500":"text-gray-900"}`,children:y.name}),y.notes&&e.jsx("div",{className:`text-xs line-clamp-2 mb-2 ${r?"text-gray-400":"text-gray-600"}`,children:y.notes}),y.recipe&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${r?"bg-gray-400":"bg-blue-500"}`}),e.jsx("span",{className:`text-xs ${r?"text-gray-400":"text-blue-600"}`,children:"Receta"})]})]}):e.jsxs(M,{variant:"outline",disabled:r,className:`flex-1 justify-start border-dashed h-auto py-3 text-sm transition-all ${r?"border-gray-200 text-gray-400 bg-gray-50 cursor-not-allowed":"border-gray-300 text-gray-600 hover:bg-gray-50 active:scale-95"}`,onClick:()=>!r&&a(t.fullDate,n),children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"truncate",children:r?"No agregado":`Agregar ${l.title.toLowerCase()}`})]})]},n)})})]})},wt=({date:t,type:s,meal:a,disabled:o,onOpenModal:i})=>{const{color:c,hoverColor:r}=k[s],x=xt(t,s);return a?e.jsxs("div",{className:`h-full p-2 rounded ${c} relative group cursor-pointer transition-all duration-200 ease-in-out hover:shadow-md ${x?"opacity-50 grayscale":""}`,onClick:()=>i(t,s,a),children:[e.jsx("p",{className:"text-sm font-medium line-clamp-2",children:a.name}),a.notes&&e.jsx("p",{className:"text-xs text-gray-600 mt-1 line-clamp-2",children:a.notes}),a.recipe&&e.jsx("div",{className:"absolute bottom-1 right-1",children:e.jsx("div",{className:"w-2 h-2 bg-sky-500 rounded-full"})}),e.jsx("div",{className:`absolute inset-0 flex items-center justify-center 
        bg-background/75 opacity-0 group-hover:opacity-100 rounded transition-opacity ${r}`,children:e.jsx(Re,{className:"h-4 w-4 text-gray-700"})})]}):e.jsx(M,{variant:"outline",className:`w-full h-full border-dashed ${x?"opacity-50":""}`,onClick:()=>i(t,s),disabled:o,children:e.jsx(je,{className:"h-4 w-4"})})},Dt=({day:t,mealPlan:s,disabled:a,onOpenModal:o})=>e.jsxs("div",{className:`px-2 ${t.isCurrentMonth?"":"bg-muted"}`,children:[e.jsxs("div",{className:"text-center py-2 border-b",children:[e.jsx("div",{className:"font-medium",children:t.dayName}),e.jsx("div",{className:"text-xs text-gray-500",children:t.fullDate.split("-").slice(1).join("/")})]}),Object.entries(k).sort(([,i],[,c])=>i.order-c.order).map(([i])=>{var c;return e.jsx("div",{className:"h-32 py-2",children:e.jsx(wt,{date:t.fullDate,type:i,meal:(c=s[t.fullDate])==null?void 0:c[i],disabled:a,onOpenModal:o})},i)})]}),$=Ge("meal"),ge=$?`https://generativelanguage.googleapis.com/v1beta/models/${$.model}:generateContent`:"",St=({selectedMeal:t,onFormChange:s,onOverwriteDay:a})=>{var le,ie;const{items:o}=ye(),[i,c]=b.useState(!1),[r,x]=b.useState(!1),[N,d]=b.useState(null),[f,n]=b.useState(""),[l,y]=b.useState(""),[h,j]=b.useState(0),p="AIzaSyAW4Ot-z7OH4ZR3OeaN7vcbkEDlWpo1aMY",w=((le=$==null?void 0:$.prompts)==null?void 0:le.meal)??"Genera una comida en formato JSON utilizando los ingredientes disponibles.",v=((ie=$==null?void 0:$.prompts)==null?void 0:ie.day)??"Genera todas las comidas del día en formato JSON.",m=$==null?void 0:$.params;b.useEffect(()=>{j(Me(f))},[f]);const g=()=>o.filter(S=>{if(S.category){const O=S.category.toLowerCase();if(["aseo","limpieza","cuidado personal","otro"].some(I=>O.includes(I)))return!1}return S.status==="in-stock"||S.status==="low-stock"}).map(S=>`${S.name} (${S.quantity})`).join(", "),u=C=>{const S=g(),O=l.trim();if(C==="meal"){let E=`${w}
Dia: ${t.date}
Tipo: ${t.type}
Ingredientes: ${S}`;O&&(E+=`
Preferencias: ${O}`),E+=`
Devuelve JSON {"name":"","notes":"","recipe":""}`,n(E)}else{let E=`${v}
Dia completo: ${t.date}
Ingredientes: ${S}`;O&&(E+=`
Preferencias: ${O}`),E+=`
Devuelve JSON con llaves ${Object.keys(k).join(", ")}.`,n(E)}d(C)},T=()=>{d(null),n(""),j(0)},q=async()=>{N==="meal"?await D(f):N==="day"&&await A(f),T()},D=async C=>{var S,O,E,I,V;c(!0);try{const R=C,L=await(await fetch(`${ge}?key=${p}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:R}]}],...m})})).json(),z=(((V=(I=(E=(O=(S=L==null?void 0:L.candidates)==null?void 0:S[0])==null?void 0:O.content)==null?void 0:E.parts)==null?void 0:I[0])==null?void 0:V.text)||"").match(/\{[\s\S]*\}/);if(z){const P=JSON.parse(z[0]);s("name",P.name||""),s("notes",P.notes||""),s("recipe",P.recipe||"")}}catch(R){console.error("AI meal error",R)}finally{c(!1)}},A=async C=>{var S,O,E,I,V;x(!0);try{const R=C,L=await(await fetch(`${ge}?key=${p}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:R}]}],...m})})).json(),z=(((V=(I=(E=(O=(S=L==null?void 0:L.candidates)==null?void 0:S[0])==null?void 0:O.content)==null?void 0:E.parts)==null?void 0:I[0])==null?void 0:V.text)||"").match(/\{[\s\S]*\}/);if(z){const P=JSON.parse(z[0]),ce={};Object.keys(k).forEach(_=>{P[_]&&(ce[_]={type:_,name:P[_].name||"",notes:P[_].notes||"",recipe:P[_].recipe||""})}),await a(ce)}}catch(R){console.error("AI day error",R)}finally{x(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(U,{placeholder:"Preferencias (opcional)",value:l,onChange:C=>y(C.target.value),className:"h-20"}),e.jsxs(M,{type:"button",onClick:()=>u("meal"),disabled:i||!p,variant:"secondary",className:"w-full flex items-center gap-2",children:[i&&e.jsx(de,{className:"w-4 h-4 animate-spin"}),e.jsx(Le,{className:"w-4 h-4"})," Generar comida"]}),e.jsxs(M,{type:"button",onClick:()=>u("day"),disabled:r||!p,variant:"ghost",className:"w-full flex items-center gap-2",children:[r&&e.jsx(de,{className:"w-4 h-4 animate-spin"}),e.jsx(_e,{className:"w-4 h-4"})," Regenerar día"]}),(i||r)&&e.jsx(Qe,{className:"mt-2"})]}),e.jsx(W,{open:N!==null,onOpenChange:C=>C?null:T(),children:e.jsxs(X,{className:"sm:max-w-xl",children:[e.jsx(K,{children:e.jsx(Q,{children:"Editar Prompt"})}),e.jsx(U,{value:f,onChange:C=>n(C.target.value),className:"max-h-[500px] overflow-y-auto"}),e.jsxs("p",{className:"text-xs text-right",children:["Tokens: ",h," ",h>3500&&e.jsx("span",{className:"text-red-500",children:"¡Prompt demasiado largo!"})]}),e.jsxs(ne,{className:"flex justify-end gap-2",children:[e.jsx(M,{type:"button",variant:"outline",onClick:T,children:"Cancelar"}),e.jsx(M,{type:"button",onClick:q,children:"Generar"})]})]})})]})},Et=({show:t,onClose:s,selectedMealInfo:a,formData:o,onFormChange:i,onSubmit:c,onDelete:r,onOverwriteDay:x,weekDays:N})=>{if(!a)return null;const d=async l=>{l.preventDefault(),await c()},f=N.find(l=>l.fullDate===a.date),n=!!a.meal;return e.jsx(W,{open:t,onOpenChange:s,children:e.jsx(X,{className:"sm:max-w-[700px]",children:e.jsxs("form",{onSubmit:d,children:[e.jsxs(K,{children:[e.jsx(Q,{children:n?"Editar Comida":"Agregar Comida"}),e.jsxs(Te,{children:[f==null?void 0:f.dayName," - ",a.date.split("-").slice(1).join("/")]})]}),e.jsxs("div",{className:"space-y-4 py-4 sm:grid sm:grid-cols-2 sm:gap-4 sm:space-y-0",children:[e.jsxs("div",{className:"space-y-1 sm:col-span-2",children:[e.jsx(B,{htmlFor:"mealName",children:"Nombre de la Comida *"}),e.jsx(xe,{id:"mealName",type:"text",value:o.name,onChange:l=>i("name",l.target.value),placeholder:"Ej: Ensalada César",required:!0})]}),e.jsxs("div",{className:"space-y-1 sm:col-span-2",children:[e.jsx(B,{htmlFor:"mealNotes",children:"Notas Adicionales"}),e.jsx(xe,{id:"mealNotes",type:"text",value:o.notes,onChange:l=>i("notes",l.target.value),placeholder:"Ej: Sin crutones"})]}),e.jsxs("div",{className:"space-y-1 sm:col-span-2",children:[e.jsx(B,{htmlFor:"mealRecipe",children:"Receta"}),e.jsx(U,{id:"mealRecipe",value:o.recipe,onChange:l=>i("recipe",l.target.value),placeholder:"Ingredientes y preparación...",className:"h-40 resize-none"})]}),e.jsx("div",{className:"sm:col-span-2",children:e.jsx(St,{selectedMeal:a,onFormChange:i,onOverwriteDay:l=>x(a.date,l)})})]}),e.jsxs(ne,{className:"flex flex-col sm:flex-row sm:justify-between gap-2",children:[e.jsx("div",{className:"flex-grow sm:flex-grow-0",children:n&&e.jsxs(rt,{children:[e.jsx(nt,{asChild:!0,children:e.jsxs(M,{type:"button",variant:"destructive",className:"w-full sm:w-auto",children:[e.jsx(Je,{className:"w-4 h-4 mr-2"}),"Eliminar"]})}),e.jsxs(ot,{children:[e.jsxs(lt,{children:[e.jsx(it,{children:"¿Estás seguro?"}),e.jsx(ct,{children:"Esta acción no se puede deshacer. Se eliminará permanentemente la comida."})]}),e.jsxs(dt,{children:[e.jsx(mt,{children:"Cancelar"}),e.jsx(pt,{onClick:r,children:"Eliminar"})]})]})]})}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-end justify-end",children:[e.jsxs("div",{children:[e.jsx(B,{htmlFor:"mealType",className:"sr-only",children:"Tipo"}),e.jsxs(Ze,{value:o.type,onValueChange:l=>i("type",l),name:"mealType",required:!0,children:[e.jsx(et,{id:"mealType",className:"sm:w-40 w-full",children:e.jsx(tt,{placeholder:"Selecciona un tipo"})}),e.jsx(st,{children:Object.entries(k).sort(([,l],[,y])=>l.order-y.order).map(([l,{title:y}])=>e.jsx(at,{value:l,children:y},l))})]})]}),e.jsx(M,{type:"button",variant:"outline",onClick:s,children:"Cancelar"}),e.jsx(M,{type:"submit",disabled:!o.name,children:n?"Actualizar":"Agregar"})]})]})]})})})},Mt=({mealPlan:t,onAddMeal:s,onRemoveMeal:a,disabled:o,selectedDate:i=new Date})=>{const{toast:c}=Z(),r=i,[x,N]=b.useState(!1),[d,f]=b.useState(null),[n,l]=b.useState({type:"breakfast",name:"",notes:"",recipe:""}),y=ht(r),h=(m,g,u)=>{f({date:m,type:g,meal:u}),l({type:(u==null?void 0:u.type)||g,name:(u==null?void 0:u.name)||"",notes:(u==null?void 0:u.notes)||"",recipe:(u==null?void 0:u.recipe)||""}),N(!0)},j=(m,g)=>{l(u=>({...u,[m]:g}))},p=async()=>{if(d)try{d.meal&&d.meal.type!==n.type&&await a(d.date,d.meal.type),await s(d.date,n.type,{type:n.type,name:n.name,notes:n.notes,recipe:n.recipe}),N(!1)}catch(m){console.error("Error al guardar:",m),c({title:"Error al Guardar",description:"No se pudo guardar la comida.",variant:"destructive"})}},w=async()=>{if(d!=null&&d.meal)try{await a(d.date,d.meal.type),N(!1)}catch(m){console.error("Error al eliminar:",m),c({title:"Error al Eliminar",description:"No se pudo eliminar la comida.",variant:"destructive"})}},v=async(m,g)=>{for(const[u,T]of Object.entries(g))await s(m,u,T);if(d){const u=g[d.type];u&&l({type:d.type,name:u.name,notes:u.notes||"",recipe:u.recipe||""})}};return e.jsxs("div",{className:"w-full h-full flex flex-col",children:[e.jsx("div",{className:"md:hidden flex-1 overflow-y-auto",children:e.jsxs("div",{className:"pb-20 px-2",children:[" ",y.map(m=>e.jsx(bt,{day:m,mealPlan:t,onOpenModal:h},m.fullDate))]})}),"      ",e.jsx("div",{className:"hidden md:block flex-1 overflow-auto",children:e.jsx("div",{className:"min-h-full p-4 lg:p-6 xl:p-8",children:e.jsxs("div",{className:"grid grid-cols-8 gap-2 lg:gap-4 xl:gap-6 min-w-[900px] lg:min-w-[1200px] xl:min-w-[1400px] h-full",children:[e.jsx("div",{className:"bg-gray-50 rounded-lg p-3 lg:p-4 xl:p-6",children:Object.entries(k).sort(([,m],[,g])=>m.order-g.order).map(([m,g])=>e.jsx("div",{className:"h-32 lg:h-36 xl:h-40 flex items-center justify-center border-b border-gray-200 last:border-b-0",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 text-center",children:[e.jsx(g.icon,{className:"h-6 w-6 lg:h-7 lg:w-7 xl:h-8 xl:w-8 text-gray-600"}),e.jsx("span",{className:"font-medium text-sm lg:text-base",children:g.title}),e.jsxs("span",{className:"text-xs lg:text-sm text-gray-500",children:[oe[m],":00"]})]})},m))}),y.map(m=>e.jsx(Dt,{day:m,mealPlan:t,disabled:o,onOpenModal:h},m.fullDate))]})})}),e.jsx(Et,{show:x,onClose:()=>N(!1),selectedMealInfo:d,formData:n,onFormChange:j,onSubmit:p,onDelete:w,onOverwriteDay:v,weekDays:y})]})},Ct=({onImport:t,disabled:s})=>{const{toast:a}=Z(),o=c=>!c||typeof c!="object"?!1:Object.entries(c).every(([r,x])=>!/^\d{4}-\d{2}-\d{2}$/.test(r)||!x||typeof x!="object"?!1:Object.entries(x).every(([d,f])=>!(!Object.keys(k).includes(d)||!f||typeof f!="object"||typeof f.name!="string"||!f.name||f.notes&&typeof f.notes!="string"||f.recipe&&typeof f.recipe!="string"))),i=c=>{var N;const r=(N=c.target.files)==null?void 0:N[0];if(!r)return;const x=new FileReader;x.onload=async d=>{var f;try{const n=(f=d.target)==null?void 0:f.result,l=JSON.parse(n);if(!o(l))throw new Error("El formato del archivo no es válido. Revisa la documentación para ver el formato correcto.");await t(l)}catch(n){console.error("Error importing:",n),a({title:"Error de Importación",description:n instanceof Error?n.message:"Formato inválido",variant:"destructive"})}},x.readAsText(r)};return e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",title:"Importar Plan",accept:"application/json",onChange:i,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:s}),e.jsxs(M,{variant:"outline",size:"sm",className:"w-full",disabled:s,children:[e.jsx(qe,{className:"h-4 w-4 mr-2"}),"Importar Plan"]})]})},Ot=({onImport:t,disabled:s})=>{const[a,o]=b.useState(!1),[i,c]=b.useState(""),{toast:r}=Z(),x=d=>!d||typeof d!="object"?!1:Object.entries(d).every(([f,n])=>!/^\d{4}-\d{2}-\d{2}$/.test(f)||!n||typeof n!="object"?!1:Object.entries(n).every(([y,h])=>!(!Object.keys(k).includes(y)||!h||typeof h!="object"||typeof h.name!="string"||!h.name||h.notes&&typeof h.notes!="string"||h.recipe&&typeof h.recipe!="string"))),N=async()=>{try{const d=JSON.parse(i);if(!x(d))throw new Error("El formato del JSON no es válido. Revisa la documentación para ver el formato correcto.");await t(d),c(""),o(!1)}catch(d){console.error("Error importing from text:",d),r({title:"Error de Importación",description:d instanceof Error?d.message:"Formato inválido",variant:"destructive"})}};return e.jsxs(W,{open:a,onOpenChange:o,children:[e.jsxs(M,{variant:"outline",size:"sm",type:"button",onClick:()=>o(!0),disabled:s,children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Pegar JSON"]}),e.jsxs(X,{children:[e.jsx(K,{children:e.jsx(Q,{children:"Pegar Plan de Comidas"})}),e.jsx(U,{value:i,onChange:d=>c(d.target.value),placeholder:"Pegue aquí el JSON del plan de comidas",className:"mt-4 min-h-[200px]"}),e.jsxs(ne,{className:"gap-2 sm:gap-0",children:[e.jsx(M,{type:"button",variant:"outline",onClick:()=>o(!1),className:"flex-1 sm:flex-none",children:"Cancelar"}),e.jsx(M,{type:"button",onClick:N,className:"flex-1 sm:flex-none",disabled:!i.trim(),children:"Importar"})]})]})]})},$t=()=>{const[t,s]=b.useState({}),[a,o]=b.useState("idle"),[i,c]=b.useState(null),{user:r}=fe(),x=Object.values(t).reduce((n,l)=>({...n,...l}),{});return b.useEffect(()=>{if(!r)return;o("loading");const n=gt(),l=Y(J,"meals",`${r.uid}_${n}`),y=He(l,j=>{if(j.exists()){const p=j.data();s(w=>({...w,[n]:p.meals||{}})),o("saved")}else s(p=>({...p,[n]:{}})),o("saved")},j=>{console.error("Error loading meal plan:",j),c(j instanceof Error?j.message:"Error al cargar el plan"),o("error")});return(async()=>{const j=Tt(),p=Ue(J,"meals");for(const w of j)if(w!==n)try{const v=We(p,pe("userId","==",r.uid),pe("yearMonth","==",w)),m=await Xe(v);m.empty?s(g=>({...g,[w]:{}})):m.forEach(g=>{const u=g.data();s(T=>({...T,[w]:u.meals||{}}))})}catch(v){console.error(`Error fetching month ${w}:`,v)}})(),()=>y()},[r]),{mealPlan:x,status:a,error:i,addMeal:async(n,l,y)=>{if(!r)return;o("saving"),c(null);const[h,j]=n.split("-"),p=`${h}-${j}`,w=`${n}_${l}`;try{const v=t[p]||{},m={...v,[n]:{...v[n],[l]:{id:w,...y}}};s(u=>({...u,[p]:m}));const g=Y(J,"meals",`${r.uid}_${p}`);await ue(g,{userId:r.uid,yearMonth:p,meals:m,updatedAt:se()},{merge:!0}),o("saved")}catch(v){throw console.error("Error adding meal:",v),c(v instanceof Error?v.message:"Error al guardar"),o("error"),v}},removeMeal:async(n,l)=>{if(!r)return;o("saving"),c(null);const[y,h]=n.split("-"),j=`${y}-${h}`;try{const p=JSON.parse(JSON.stringify(t[j]||{}));if(p[n]){const v={...p[n]};delete v[l],Object.keys(v).length===0?delete p[n]:p[n]=v}s(v=>({...v,[j]:p}));const w=Y(J,"meals",`${r.uid}_${j}`);await ue(w,{userId:r.uid,yearMonth:j,meals:p,updatedAt:se()}),o("saved")}catch(p){throw console.error("Error removing meal:",p),c(p instanceof Error?p.message:"Error al eliminar"),o("error"),p}},importMealPlan:async n=>{if(r){o("saving"),c(null);try{const l=Object.entries(n).reduce((h,[j,p])=>{const[w,v]=j.split("-"),m=`${w}-${v}`;return h[m]||(h[m]={}),h[m][j]=Object.entries(p).reduce((g,[u,T])=>{const q=`${j}_${u}`;return g[u]={...T,id:q,type:u},g},{}),h},{});s(h=>({...h,...l}));const y=Ke(J);Object.entries(l).forEach(([h,j])=>{const p=Y(J,"meals",`${r.uid}_${h}`);y.set(p,{userId:r.uid,yearMonth:h,meals:j,updatedAt:se()},{merge:!0})}),await y.commit(),o("saved")}catch(l){throw console.error("Error importing meal plan:",l),c(l instanceof Error?l.message:"Error al importar"),o("error"),l}}}}},Tt=()=>{const t=new Date,s=t.getFullYear(),a=t.getMonth()+1,o=t.getDate(),i=new Date(s,a,0).getDate(),c=String(a).padStart(2,"0"),r=[`${s}-${c}`];if(i-o<7){let x=a+1,N=s;x>12&&(x=1,N=s+1);const d=String(x).padStart(2,"0");r.push(`${N}-${d}`)}return r},kt=({selectedDate:t})=>{const{user:s}=fe(),{toast:a}=Z(),[o,i]=b.useState(!1),{mealPlan:c,status:r,error:x,addMeal:N,removeMeal:d,importMealPlan:f}=$t(),{items:n}=ye(),{recipes:l}=ke(),{meals:y}=ut();if(!s)return e.jsx(be,{className:"w-full h-full",children:e.jsx(we,{className:"p-4 text-center",children:e.jsx("p",{children:"Inicia sesión para planificar tus comidas"})})});const h=async(...m)=>{try{await N(...m)}catch(g){console.error("Error adding meal:",g),a({title:"Error al Agregar",description:"No se pudo agregar la comida.",variant:"destructive"})}},j=async(...m)=>{try{await d(...m)}catch(g){console.error("Error removing meal:",g),a({title:"Error al Eliminar",description:"No se pudo eliminar la comida.",variant:"destructive"})}},p=async(...m)=>{try{await f(...m),a({title:"Importación Exitosa",description:"El plan de comidas se ha importado correctamente."}),i(!1)}catch(g){console.error("Error importing meal plan:",g),a({title:"Error al Importar",description:"No se pudo importar el plan de comidas.",variant:"destructive"})}},w=()=>{const m=JSON.stringify(c,null,2);navigator.clipboard.writeText(m).then(()=>{a({title:"Plan de comidas copiado al portapapeles"})})},v=()=>{const m=n.reduce((D,A)=>(A.category==="Aseo y Limpieza"||(A.status==="in-stock"?D.inStock.push({name:A.name,quantity:A.quantity}):A.status==="low-stock"&&D.lowStock.push({name:A.name,quantity:A.quantity})),D),{inStock:[],lowStock:[]}),g=y.map(D=>({name:D.name,...D.portions!==void 0&&{portions:D.portions}})),u=l.filter(D=>D.favorite===!0).map(D=>({name:D.name,...D.description&&{description:D.description}})),q=JSON.stringify({shoppingList:m,preparedMeals:g,recipes:u},null,2);navigator.clipboard.writeText(q).then(()=>{a({title:"Ingredientes y recetas copiados al portapapeles"})})};return e.jsxs("div",{className:"w-full h-full flex flex-col",children:["      ",e.jsxs("div",{className:"flex items-center justify-between p-4 bg-white border-b sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-bold",children:"Plan de Comidas"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ze,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-xs sm:text-sm text-gray-500",children:"Semanal"})]}),e.jsx(ee,{to:"/shopping-list",className:"text-sm text-blue-600 underline",children:"Lista de Compras"}),e.jsx(ee,{to:"/recipes",className:"text-sm text-blue-600 underline",children:"Recetas"}),e.jsx(ee,{to:"/prepared-meals",className:"text-sm text-blue-600 underline",children:"Comidas Preparadas"})]}),e.jsxs(Ce,{children:[e.jsx(Oe,{asChild:!0,children:e.jsxs(M,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:[e.jsx(Fe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Opciones"})]})}),e.jsxs($e,{align:"end",children:[e.jsxs(te,{onClick:()=>i(!0),children:[e.jsx(Ye,{className:"mr-2 h-4 w-4"}),"Importar Plan"]}),e.jsxs(te,{onClick:w,children:[e.jsx(me,{className:"mr-2 h-4 w-4"}),"Exportar Plan"]}),e.jsxs(te,{onClick:v,children:[e.jsx(me,{className:"mr-2 h-4 w-4"}),"Exportar ingredientes y recetas"]})]})]})]}),e.jsxs("div",{className:"flex-1 bg-gray-50 overflow-hidden",children:[e.jsx(Mt,{mealPlan:c,onAddMeal:h,onRemoveMeal:j,disabled:r==="saving",selectedDate:t}),x&&e.jsxs(Se,{variant:"destructive",className:"m-4",children:[e.jsx(Be,{className:"h-4 w-4"}),e.jsx(Ee,{className:"text-sm",children:x})]})]}),e.jsx(W,{open:o,onOpenChange:i,children:e.jsxs(X,{className:"sm:max-w-md",children:[e.jsx(K,{children:e.jsx(Q,{children:"Importar Plan de Comidas"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Puedes importar un plan de comidas desde un archivo JSON o pegando el contenido directamente."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ct,{onImport:p,disabled:r==="saving"}),e.jsx(Ot,{onImport:p,disabled:r==="saving"})]})]})]})})]})},ls=()=>e.jsx(De,{noPadding:!0,className:"h-full",children:e.jsx(kt,{selectedDate:new Date})});export{ls as default};
