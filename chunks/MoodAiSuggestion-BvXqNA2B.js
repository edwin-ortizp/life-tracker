import{j as e}from"./ui-vendor-DGxrBG5B.js";import{B as N,u as X,d as E}from"../assets/index-B6EFx1d9.js";import{M as j}from"./index-DuocBWKh.js";import{r as a}from"./react-vendor-B6CgFIIW.js";import{D as tt,a as et,b as st,c as at}from"./dialog-k0qgUnZO.js";import{g as nt}from"./ai-9sQAZSA0.js";import{e as J,f as L,l as ot,j as rt}from"./firebase-B1tATv4n.js";import{g as z,c as it}from"./dates-LQzD1DbF.js";import{c as ct,p as lt}from"./tokens-lK1rltPv.js";import{T as mt}from"./textarea-D04ZjWHU.js";import{Z as dt,j as P}from"./chart-vendor-DS0HZnUf.js";const At=({onSelect:i,disabled:c})=>e.jsx("div",{className:"grid grid-cols-3 gap-2 mb-4",children:j.map(r=>e.jsx("div",{className:"relative",children:e.jsxs(N,{variant:"outline",onClick:()=>i(r),className:"h-12 text-lg w-full relative",disabled:c,children:[e.jsx("span",{children:r.emoji}),e.jsx("span",{className:"w-full text-center text-xs text-gray-500 mt-1",children:r.text})]})},r.emoji))}),ut={entry:"",setEntry:()=>{}},U=a.createContext(ut),Dt=({children:i})=>{const[c,r]=a.useState("");return e.jsx(U.Provider,{value:{entry:c,setEntry:r},children:i})},xt=()=>a.useContext(U),pt={isUnlocked:!1,setUnlocked:()=>{}},H=a.createContext(pt),bt=({children:i})=>{const[c,r]=a.useState(!1);return e.jsx(H.Provider,{value:{isUnlocked:c,setUnlocked:r},children:i})},gt=()=>a.useContext(H),d=nt("mood"),ft=d?`https://generativelanguage.googleapis.com/v1beta/models/${d.model}:generateContent`:"",Tt=({selectedDate:i,open:c,onOpenChange:r})=>{const{user:p}=X(),{entry:M}=xt(),{isUnlocked:I}=gt(),[R,_]=a.useState(!1),v=c!==void 0?c:R,C=r??_,[x,A]=a.useState(!1),[D,h]=a.useState([]),[y,k]=a.useState(""),[b,T]=a.useState(0),$="AIzaSyAW4Ot-z7OH4ZR3OeaN7vcbkEDlWpo1aMY",B=j.map(t=>t.text).join(", "),W=(d==null?void 0:d.prompt)??'Analiza la siguiente entrada del diario y sugiere estados de ánimo en formato JSON: [{"emoji":"","text":"","time":"HH:mm","reason":""}]',Z=d==null?void 0:d.params;if(!I)return null;a.useEffect(()=>{v&&(async()=>{const t=M||await F();k(`${W}
Moods disponibles: ${B}. Solo usa estos valores.
${t}`)})()},[v,M]),a.useEffect(()=>{T(ct(y))},[y]);const F=async()=>{if(!p)return"";const t=z(i),n=J(E,"journal",`${p.uid}_${t}`),o=await L(n);return o.exists()&&o.data().text||""},K=t=>{try{const n=t.match(/\[[\s\S]*\]/);if(!n)return[];const o=JSON.parse(n[0]);if(!Array.isArray(o))return[];const u=new Set(j.map(s=>s.text)),l={mañana:"09:00",tarde:"15:00",noche:"21:00"},m=new Map(j.map(s=>[s.text,s.emoji]));return o.filter(s=>u.has(s.text)).map(s=>({...s,emoji:s.emoji||m.get(s.text)||"",time:s.time||l[s.timeOfDay??""]||"12:00"}))}catch{return[]}},V=async t=>{var n,o,u,l,m;A(!0);try{if(!t.trim()){h([]);return}const g=await(await fetch(`${ft}?key=${$}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t}]}],...Z})})).json(),f=((m=(l=(u=(o=(n=g==null?void 0:g.candidates)==null?void 0:n[0])==null?void 0:o.content)==null?void 0:u.parts)==null?void 0:l[0])==null?void 0:m.text)||"",w=K(f);h(w)}catch{h([])}finally{A(!1)}},Y=async t=>{if(!p)return;const n=z(i),o=`${p.uid}_${n}`,u=J(ot(E,"moods"),o);let l=12,m=0;if(t.time){const[S,Q]=t.time.split(":").map(Number);l=S??12,m=Q??0}else t.timeOfDay&&(l={mañana:9,tarde:15,noche:21}[t.timeOfDay]??12);const s=`${l.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`,g=it(i,l,m),f=await L(u),w=f.exists()&&Array.isArray(f.data().moods)?f.data().moods:[],O=j.find(S=>S.text===t.text),G={emoji:t.emoji||(O==null?void 0:O.emoji)||"",text:t.text,time:s,timestamp:g.timestamp};await rt(u,{id:o,userId:p.uid,date:n,moods:[...w,G]})},q=()=>{C(!1),h([]),k(""),T(0)};return e.jsxs(tt,{open:v,onOpenChange:t=>t?C(!0):q(),children:[c===void 0&&e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>C(!0),className:"flex items-center gap-2",children:[e.jsx(dt,{className:"h-4 w-4"}),"Analizar Diario"]}),e.jsxs(et,{className:"max-w-2xl",children:[e.jsx(st,{children:e.jsx(at,{children:"Sugerencias de estados de ánimo"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(mt,{value:y,onChange:t=>k(t.target.value),className:"max-h-[500px] overflow-y-auto"}),e.jsxs("p",{className:"text-xs text-right",children:["Tokens: ",b," ",b>3500&&e.jsx("span",{className:"text-red-500",children:"¡Prompt demasiado largo!"})]}),e.jsxs(N,{onClick:()=>V(y),disabled:x||!$,className:"w-full flex items-center justify-center gap-2",children:[x&&e.jsx(P,{className:"h-4 w-4 animate-spin"}),x?"Consultando...":"Analizar"]}),x&&e.jsxs("p",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(P,{className:"h-4 w-4 animate-spin"})," Consultando..."]}),!x&&D.map((t,n)=>e.jsxs("div",{className:"border rounded p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:t.emoji}),e.jsx("span",{children:t.text}),e.jsx("span",{className:"ml-auto text-sm text-gray-500",children:t.time})]}),t.reason&&e.jsx("p",{className:"text-sm text-gray-500",dangerouslySetInnerHTML:{__html:lt.sanitize(t.reason)}}),e.jsx(N,{size:"sm",className:"ml-auto",onClick:()=>Y(t),children:"Registrar"})]},n)),!x&&D.length===0&&e.jsx("p",{className:"text-sm text-center text-gray-500",children:"No se encontraron sugerencias"})]})]})]})};export{Dt as J,Tt as M,bt as a,xt as b,At as c,gt as u};
