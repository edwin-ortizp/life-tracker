import{j as e}from"./ui-vendor-DGxrBG5B.js";import{r as p,c as X}from"./react-vendor-B6CgFIIW.js";import{C as R,c as W}from"./PageLayout-CQ502YZp.js";import{B as k,c as re,u as Q,d as Y}from"../assets/index-CZllZBvh.js";import{a9 as ne,ab as oe,F as le,ac as ce,ad as G,ae as ie,af as de,x as me,Z as ee,j as ue}from"./chart-vendor-DS0HZnUf.js";import{H as V,a as pe}from"./index-NpWkTw_R.js";import{g as F}from"./dates-LQzD1DbF.js";import{P as xe}from"./progress-CKnY0O-_.js";import{A as ge,a as fe,b as he,c as je}from"./accordion-OgLUcSe4.js";import{Y as ye}from"./YearlyActivityGrid-Dw4RT37g.js";import{e as J,h as Ne,l as we,m as be,q as ve,w as Z,j as De,k as Se}from"./firebase-B1tATv4n.js";import{c as $e,p as K,D as ke,a as Ce,b as Me,d as Oe}from"./tokens-DP8wmanu.js";import{D as Ae,a as He,b as Te,c as Ee,f as Ie}from"./dialog-Ch6bvtCJ.js";import{m as se}from"./marked.esm-BiyRy7sW.js";import{g as _e}from"./ai-BhB6E9je.js";import{T as ze}from"./textarea-DJSkO8fg.js";const Ye=({view:t,onViewChange:a})=>e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(k,{variant:t==="weekly"?"default":"outline",size:"sm",onClick:()=>a("weekly"),className:"gap-2",children:[e.jsx(ne,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Semanal"})]}),e.jsxs(k,{variant:t==="graph"?"default":"outline",size:"sm",onClick:()=>a("graph"),className:"gap-2",children:[e.jsx(oe,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Anual"})]})]}),te=(t=new Date)=>{const a=new Date(t);let c=a.getDay();c=c===0?6:c-1;const n=[];for(let i=0;i<7;i++){const r=new Date(a);r.setDate(a.getDate()-c+i),n.push({dayName:["L","M","X","J","V","S","D"][i],fullDate:F(r)})}return n},U={morning:{icon:ce,title:"Ma√±ana",defaultOpen:()=>{const t=new Date().getHours();return t>=5&&t<12}},afternoon:{icon:G,title:"Tarde",defaultOpen:()=>{const t=new Date().getHours();return t>=12&&t<18}},night:{icon:ie,title:"Noche",defaultOpen:()=>{const t=new Date().getHours();return t>=18||t<5}},anytime:{icon:G,title:"Cualquier momento",defaultOpen:()=>!1}},Ve=t=>t>=.9?"¬°Incre√≠ble! ¬°Sigue as√≠! üåü":t>=.7?"¬°Vas muy bien! ¬°No pares! üí™":t>=.5?"¬°Buen progreso! ¬°Sigue adelante! üéØ":t>=.3?"¬°Cada peque√±o paso cuenta! üå±":"¬°Hoy es un buen d√≠a para empezar! üöÄ",Fe=(t,a)=>{const c=new Date;let n=0;for(let i=0;i<30;i++){const r=new Date(c);r.setDate(r.getDate()-i);const s=F(r);if(t.every(d=>a[`${d.id}_${s}`]))n++;else if(i<7)break}return n},ae=({children:t,completedHabits:a})=>{const[c,n]=p.useState(()=>Object.entries(U).filter(([s,o])=>o.defaultOpen()).map(([s])=>s)),i=X.useMemo(()=>V.reduce((s,o)=>(s[o.timeOfDay]||(s[o.timeOfDay]=[]),s[o.timeOfDay].push(o),s),{}),[]),r=s=>{const o=te(),d=F(),u=s.filter(x=>a[`${x.id}_${d}`]).length;let l=0;const g=s.length*o.length;return o.forEach(x=>{s.forEach(N=>{a[`${N.id}_${x.fullDate}`]&&l++})}),{daily:{completed:u,total:s.length},weekly:{completed:l,total:g}}};return e.jsx(ge,{type:"multiple",value:c,onValueChange:n,className:"w-full space-y-4",children:Object.entries(i).map(([s,o])=>{const d=U[s],u=d.icon,l=r(o),g=Fe(o,a),x=l.daily.completed/l.daily.total;return e.jsxs(fe,{value:s,className:"rounded-lg border border-gray-200 overflow-hidden",children:[e.jsx(he,{className:"w-full px-6 py-4 flex items-center justify-between text-left hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring data-[state=closed]:rounded-b-lg data-[state=open]:border-b",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:d.title}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["Hoy: ",l.daily.completed,"/",l.daily.total]}),e.jsxs("span",{className:"text-sm text-gray-500",children:["Semana: ",l.weekly.completed,"/",l.weekly.total]}),g>0&&e.jsxs("div",{className:"flex items-center gap-1 text-amber-500",children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:g})]})]})]})}),e.jsx(je,{className:"px-6 py-4",children:e.jsxs("div",{className:"space-y-6",children:[t(o),e.jsxs("div",{className:"pt-2 space-y-3 border-t border-gray-100",children:[e.jsx(xe,{value:l.daily.completed/l.daily.total*100,className:"h-2"}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:Ve(x)}),l.daily.completed===l.daily.total&&e.jsxs("div",{className:"flex items-center gap-1 text-green-500",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{children:"¬°Completado!"})]})]})]})]})})]},s)})})},Pe=({completedHabits:t,onToggle:a,disabled:c})=>{const n=te(new Date),i=r=>e.jsx("div",{className:"overflow-x-auto",children:e.jsx("div",{className:"min-w-[480px] sm:min-w-[600px]",children:e.jsxs("div",{className:"grid grid-cols-[minmax(80px,140px)_repeat(7,minmax(32px,1fr))] sm:grid-cols-[minmax(120px,180px)_repeat(7,minmax(40px,1fr))] gap-1 sm:gap-2",children:[e.jsx("div",{}),n.map(s=>e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-xs sm:text-sm",children:s.dayName}),e.jsx("div",{className:"text-[9px] sm:text-[10px] text-gray-400",children:s.fullDate.split("-").slice(1).join("/")})]},s.fullDate)),r.map(s=>e.jsxs(X.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 pr-1",children:[e.jsx("span",{className:"text-sm sm:text-base shrink-0",children:s.icon}),e.jsxs("div",{className:"flex flex-col min-w-0 flex-1",children:[e.jsx("span",{className:"text-xs sm:text-sm font-medium truncate leading-tight",children:s.name}),e.jsx("span",{className:"text-[10px] sm:text-xs text-gray-500 truncate leading-tight",children:s.goal})]})]}),n.map(o=>{const d=t[`${s.id}_${o.fullDate}`];return e.jsx(k,{variant:d?"default":"outline",className:`h-8 w-8 sm:h-10 sm:w-10 p-0 aspect-square rounded-lg flex items-center justify-center transition-colors mx-auto my-0.5 sm:my-1
                      ${d?pe[s.id]:"border-gray-300"}`,onClick:()=>a(s.id,o.fullDate),disabled:c,children:d?e.jsx(me,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"}):null},`${s.id}_${o.fullDate}`)})]},s.id))]})})});return e.jsx("div",{className:"w-full",children:e.jsx(ae,{completedHabits:t,children:i})})},Be=({completedHabits:t,onToggle:a})=>{const c=new Date().getFullYear(),n=i=>e.jsx("div",{className:"space-y-8",children:i.map(r=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("span",{className:"text-xl",children:r.icon}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold text-base",children:r.name}),e.jsxs("span",{className:"text-sm text-gray-600 ml-2",children:["(",r.goal,")"]})]})]}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsx(ye,{year:c,renderCell:s=>{const o=t[`${r.id}_${s}`],d=new Date().toISOString().split("T")[0]===s;return e.jsx(k,{variant:"ghost",onClick:()=>a(r.id,s),className:re("w-3 h-3 p-0 rounded-full border transition-all duration-200 hover:scale-110",o?"bg-green-600 border-green-700 hover:bg-green-700":"bg-gray-100 border-gray-200 hover:bg-gray-200 hover:border-gray-300",d&&"ring-2 ring-blue-400 ring-offset-1"),title:`${r.name} - ${new Date(s).toLocaleDateString("es-ES")}${o?" (Completado)":""}`})}}),e.jsxs("div",{className:"flex items-center gap-2 mt-4 text-xs text-gray-600",children:[e.jsx("span",{children:"Menos"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-3 h-3 bg-gray-100 border border-gray-200 rounded-full"}),e.jsx("div",{className:"w-3 h-3 bg-green-200 border border-green-300 rounded-full"}),e.jsx("div",{className:"w-3 h-3 bg-green-400 border border-green-500 rounded-full"}),e.jsx("div",{className:"w-3 h-3 bg-green-600 border border-green-700 rounded-full"})]}),e.jsx("span",{children:"M√°s"})]})]})]},r.id))});return e.jsx("div",{className:"w-full",children:e.jsx(ae,{completedHabits:t,children:n})})},Le=()=>{const[t,a]=p.useState({}),[c,n]=p.useState("idle"),[i,r]=p.useState(null),{user:s}=Q(),o=p.useMemo(()=>Object.values(t).reduce((u,l)=>({...u,...l}),{}),[t]);return p.useEffect(()=>{if(!s)return;const u=new Date,l=u.getFullYear(),g=u.getMonth()+1,x=`${l}-${String(g).padStart(2,"0")}`,N=J(Y,"habits",`${s.uid}_${x}`),v=Ne(N,h=>{if(h.exists()){const D=h.data();a(j=>({...j,[x]:D.habits||{}})),n("saved")}},h=>{r(h instanceof Error?h.message:"An unknown error occurred"),n("error")});return(async()=>{const h=qe(u),D=we(Y,"habits");for(const j of h)if(j!==x)try{(await be(ve(D,Z("userId","==",s.uid),Z("yearMonth","==",j)))).forEach(T=>{const E=T.data();a(I=>({...I,[j]:E.habits||{}}))})}catch(A){console.error(`Error fetching month ${j}:`,A)}})(),()=>v()},[s]),{completedHabits:o,status:c,error:i,toggleHabit:async(u,l)=>{if(!s)return;n("saving"),r(null);const[g,x]=l.split("-"),N=`${g}-${x}`,v=`${u}_${l}`,C=t[N]||{},h={...C,[v]:!C[v]},D=J(Y,"habits",`${s.uid}_${N}`);try{await De(D,{userId:s.uid,yearMonth:N,habits:h,updatedAt:Se()},{merge:!0}),n("saved")}catch(j){r(j instanceof Error?j.message:"Error al guardar"),n("error")}}}},qe=t=>{const a=[],c=t.getFullYear();for(let n=1;n<=12;n++)a.push(`${c}-${String(n).padStart(2,"0")}`);return a},y=_e("habit"),Re=y?`https://generativelanguage.googleapis.com/v1beta/models/${y.model}:generateContent`:"";se.setOptions({breaks:!0,gfm:!0});const We=({completedHabits:t,open:a,onOpenChange:c})=>{var P,B;const[n,i]=p.useState(!1),r=a!==void 0?a:n,s=c??i,[o,d]=p.useState(""),[u,l]=p.useState(""),[g,x]=p.useState(!1),[N,v]=p.useState(0),C="AIzaSyAW4Ot-z7OH4ZR3OeaN7vcbkEDlWpo1aMY",h=((P=y==null?void 0:y.prompts)==null?void 0:P.predict)??"Analiza mis h√°bitos recientes y predice cu√°les pueden fallar. Dame consejos para cumplirlos.",D=((B=y==null?void 0:y.prompts)==null?void 0:B.suggest)??"Sugiere nuevos h√°bitos basados en mis intereses y actividades.",j=y==null?void 0:y.params;p.useEffect(()=>{if(r){const m=T();l(`${h}
${D}
${m}`)}else l(""),d("")},[r,t]),p.useEffect(()=>{v($e(u))},[u]);const A=m=>{try{const f=se.parse(m);return K.sanitize(f)}catch(f){return console.error("Error procesando Markdown:",f),K.sanitize(m.replace(/\n/g,"<br>"))}},T=()=>{const m={};let f=null,b=null;const M=new Set;Object.entries(t).forEach(([w,S])=>{const[z,$]=w.split("_"),L=parseInt(z,10);if(M.add($),(!f||$<f)&&(f=$),(!b||$>b)&&(b=$),S){const q=m[L]||{success:0,fail:0};q.success+=1,m[L]=q}});const H=Array.from(M).sort();V.forEach(w=>{const S=m[w.id]||{success:0,fail:0};H.forEach(z=>{const $=`${w.id}_${z}`;t[$]||(S.fail+=1)}),m[w.id]=S});const _=f&&b?`Datos del ${f} al ${b}`:"Sin registros",O=V.map(w=>{const S=m[w.id]||{success:0,fail:0};return`- ${w.name}: completado ${S.success} veces, no ejecutado ${S.fail} veces`}).join(`
`);return`${_}
${O}`},E=async()=>{var m,f,b,M,H;x(!0);try{const O=await(await fetch(`${Re}?key=${C}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:u}]}],...j})})).json(),w=(H=(M=(b=(f=(m=O==null?void 0:O.candidates)==null?void 0:m[0])==null?void 0:f.content)==null?void 0:b.parts)==null?void 0:M[0])==null?void 0:H.text;d(w||"No se pudo obtener sugerencia")}catch{d("Error al consultar la API")}finally{x(!1)}},I=()=>{s(!1),d(""),l(""),v(0)};return e.jsxs(Ae,{open:r,onOpenChange:m=>m?s(!0):I(),children:[a===void 0&&e.jsxs(k,{size:"sm",variant:"outline",onClick:()=>s(!0),className:"flex items-center gap-2",children:[e.jsx(ee,{className:"w-4 h-4"}),"Analizar h√°bitos"]}),e.jsxs(He,{className:"w-full sm:max-w-5xl max-h-[90vh] overflow-auto",children:[e.jsxs(Te,{children:[e.jsx(Ee,{children:"Sugerencias de h√°bitos"}),e.jsx(Ie,{children:"Predicci√≥n de fallos y recomendaciones."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(ze,{value:u,onChange:m=>l(m.target.value),className:"max-h-[500px] overflow-y-auto"}),e.jsxs("p",{className:"text-xs text-right",children:["Tokens: ",N," ",N>3500&&e.jsx("span",{className:"text-red-500",children:"¬°Prompt demasiado largo!"})]}),e.jsxs(k,{onClick:E,disabled:g||!C,className:"w-full flex items-center justify-center gap-2",children:[g&&e.jsx(ue,{className:"w-4 h-4 animate-spin"}),g?"Consultando...":"Obtener sugerencia"]}),"          ",o&&e.jsx("div",{className:"p-4 bg-muted rounded-md",children:e.jsx("div",{className:`prose prose-sm max-w-none dark:prose-invert\r
                  prose-headings:text-foreground prose-p:text-foreground \r
                  prose-strong:text-foreground prose-ul:text-foreground \r
                  prose-ol:text-foreground prose-li:text-foreground\r
                  prose-code:bg-accent prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:text-foreground\r
                  prose-pre:bg-accent prose-pre:border prose-pre:text-foreground\r
                  prose-blockquote:border-l-accent prose-blockquote:text-foreground`,dangerouslySetInnerHTML:{__html:A(o)}})})]})]})]})},Ge=({completedHabits:t})=>{const[a,c]=p.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(ke,{children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(k,{size:"sm",variant:"outline",className:"flex items-center gap-2 text-blue-600",children:[e.jsx(ee,{className:"w-4 h-4"}),"IA"]})}),e.jsx(Me,{align:"end",children:e.jsx(Oe,{onSelect:()=>c(!0),children:"Analizar h√°bitos"})})]}),e.jsx(We,{completedHabits:t,open:a,onOpenChange:c})]})},ds=()=>{const[t,a]=p.useState("weekly"),{user:c}=Q(),{completedHabits:n,status:i,error:r,toggleHabit:s}=Le();return c?e.jsx(R,{className:"w-full",children:e.jsxs(W,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"font-medium text-lg",children:"H√°bitos"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{completedHabits:n}),e.jsx(Ye,{view:t,onViewChange:a})]})]}),t==="weekly"?e.jsx(Pe,{completedHabits:n,onToggle:s,disabled:i==="saving"}):e.jsx(Be,{completedHabits:n,onToggle:s}),r&&e.jsx("p",{className:"mt-4 text-sm text-red-500",children:r})]})}):e.jsx(R,{className:"w-full",children:e.jsx(W,{className:"p-4 text-center",children:e.jsx("p",{children:"Inicia sesi√≥n para registrar tus h√°bitos"})})})};export{ds as H};
